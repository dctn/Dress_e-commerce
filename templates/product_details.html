{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.base_product.name }}</title>
    <link rel="stylesheet" href="{% static 'product_details.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
</head>

<style>
    .product-image {
        width: 100%;
        height: 300px; /* set uniform height */
        object-fit: cover; /* crop image but keep quality */
        object-position: center; /* keep focus centered */
        border-radius: 8px;
    }
</style>

<body>

<div class="container">
    <div class="navbar">
        <div class="logo">
            <a href="{% url 'index' %}"><img src="{% static 'product_details_images/logo.png' %}" alt="logo"
                                             width="125px"></a>
        </div>
        <nav>
            <ul id="MenuItems">
                <li><a href="{% url 'index' %}">Home</a></li>
                <li><a href="{% url 'products' %}">Products</a></li>
                <li><a href="">About</a></li>
                <li><a href="">Contact</a></li>
                <li><a href="{% url 'account_logout' %}">Logout</a></li>
            </ul>
        </nav>
        <a href="{% url 'cart' %}"><img src="{% static 'product_details_images/cart.png' %}" width="30px" height="30px"></a>
        <img src="{% static 'product_details_images/menu.png' %}" class="menu-icon" onclick="menutoggle()">
    </div>
</div>

<!-- Single Products -->
<div class="small-container single-product">
    <div class="row">
        <div class="col-2">
            <img src="{{ product.image_1.url }}" width="100%" id="ProductImg" class="">

            <div class="small-img-row">
                <div class="small-img-col">
                    <img src="{{ product.image_1.url }}" width="100%" class="small-img">
                </div>
                {% if product.image_2 %}
                    <div class="small-img-col">
                        <img src="{{ product.image_2.url }}" width="100%" class="small-img">
                    </div>
                {% endif %}

                {% if product.image_3 %}
                    <div class="small-img-col">
                        <img src="{{ product.image_3.url }}" width="100%" class="small-img">
                    </div>
                {% endif %}

                {% if product.image_4 %}
                    <div class="small-img-col">
                        <img src="{{ product.image_4.url }}" width="100%" class="small-img">
                    </div>
                {% endif %}
            </div>

        </div>
        <div class="col-2">
            <p>Home / T-Shirt</p>
            <h1 class="product-title" style="word-wrap: break-word">{{ product.base_product.name }}</h1>

            {% for tag in product.tag.all %}
                <a href="{% url 'products_filter_tag' tag.name %}" class="page-btn"
                   style="border: orange 2px dashed; border-radius: 20px; padding: 5px 5px;">{{ tag.name }}</a>
            {% endfor %}
            <h3 style="margin-top: 10px;">Product Details</h3>
            <br>
            <p class="product-description">
                {{ product.base_product.desp|linebreaksbr }}
            </p>

            {% if product.price %}
                <h4 id="price">‚Çπ{{ product.price }}</h4>
            {% elif product.price_per_inches %}
                <h4 id="price">‚Çπ{{ product.price_per_inches }} per inch</h4>
            {% endif %}
            <select id="product_size">
                <option>Select Size</option>
                <option>XXL</option>
                <option>XL</option>
                <option>L</option>
                <option>M</option>
                <option>S</option>
            </select>

            <div style="display: flex; align-items: center">
                <input type="checkbox" class="form-check-input" id="stitched_option" style="width: 20px;">
                <label class="form-check-label" style="font-weight: bold" for="stitched_option" >Stitched (extra: ‚Çπ1000)</label>
            </div>

            {% if product.stock > 0 %}
                {% if product.price_per_inches %}
                    <input type="number" value="25" min="25" max="{{ product.stock }}" id="qtyInput"
                           style="width: 70px;">
                {% else %}
                    <input type="number" value="1" min="1" max="{{ product.stock }}" id="qtyInput"
                           style="width: 70px;">
                {% endif %}
                <button class="btn" id="add_cart">Add To Cart</button>
            {% else %}
                <h4 class="" style="color: red">Sold out</h4>

            {% endif %}

        </div>
    </div>
</div>


<!-- title -->
<div class="small-container">
    <div class="row row-2">
        <h2>Related Products</h2>
        {#        <p>View More</p>#}
    </div>
</div>
<!-- Products -->
<div class="small-container">
    <div class="row">
        {% for base_product in related_base_product %}
            {% if base_product.variant_id != product.variant_id %}

                <div class="col-4">
                    <a href="{% url 'product_details' base_product.variant_id %}">
                        <img src="{{ base_product.image_1.url }}" class="product-image">
                        <h4>{{ base_product.base_product.name }}</h4>
                        <div class="rating">
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star-o"></i>
                        </div>
                        {% if product.price %}
                            {% if product.is_discount %}
                                <h3 class="mt-2 mb-0 small">
                                    <s class="text-muted">‚Çπ{{ product.price }}</s>
                                    <span class="text-danger">‚Çπ{{ product.discount_price }}</span>
                                </h3>
                            {% else %}
                                <h3 class="text-danger">‚Çπ{{ product.price }}</h3>
                            {% endif %}
                        {% elif product.price_per_inches %}
                            <h3 class="text-danger">‚Çπ{{ product.price_per_inches }} per inch</h3>

                        {% endif %}
                    </a>
                </div>

            {% endif %}
        {% endfor %}
    </div>
</div>


<!-- Footer -->
<div class="footer">
    <div class="container">
        <div class="row">
            <div class="footer-col-1">
                <h3>Download Our App</h3>
                <p>Download App for Android and ios mobile phone.</p>
                <div class="app-logo">
                    <img src="images/play-store.png">
                    <img src="images/app-store.png">
                </div>
            </div>
            <div class="footer-col-2">
                <img src="images/logo-white.png">
                <p>Our Purpose Is To Sustainably Make the Pleasure and Benefits of Sports Accessible to the Many.
                </p>
            </div>
            <div class="footer-col-3">
                <h3>Useful Links</h3>
                <ul>
                    <li>Coupons</li>
                    <li>Blog Post</li>
                    <li>Return Policy</li>
                    <li>Join Affiliate</li>
                </ul>
            </div>
            <div class="footer-col-4">
                <h3>Follow Us</h3>
                <ul>
                    <li>Facebook</li>
                    <li>Twitter</li>
                    <li>Instagram</li>
                    <li>Youtube</li>
                </ul>
            </div>
        </div>
        <hr>
        <p class="copyright">Copyright 2020 - Samwit Adhikary</p>
    </div>
</div>

<!-- javascript -->

<script>
    var MenuItems = document.getElementById("MenuItems");
    MenuItems.style.maxHeight = "0px";

    function menutoggle() {
        if (MenuItems.style.maxHeight == "0px") {
            MenuItems.style.maxHeight = "200px"
        } else {
            MenuItems.style.maxHeight = "0px"
        }
    }
</script>

<!-- product gallery -->
<script>
    var ProductImg = document.getElementById("ProductImg");
    var SmallImg = document.getElementsByClassName("small-img");

    SmallImg[0].onclick = function () {
        ProductImg.src = SmallImg[0].src;
    }
    SmallImg[1].onclick = function () {
        ProductImg.src = SmallImg[1].src;
    }
    SmallImg[2].onclick = function () {
        ProductImg.src = SmallImg[2].src;
    }
    SmallImg[3].onclick = function () {
        ProductImg.src = SmallImg[3].src;
    }

</script>

{# values#}
<script>
    document.addEventListener("DOMContentLoaded", function () {

        const qtyInput = document.getElementById("qtyInput");
        const singlePriceElement = document.getElementById("price");

        // Get price and remove ‚Çπ if present
        const basePrice = parseFloat(singlePriceElement.innerText.replace("‚Çπ", "").trim());

        function updatePrice() {
            let quantity = parseInt(qtyInput.value);
            if (isNaN(quantity) || quantity < 1) {
                quantity = 1;
                qtyInput.value = 1;
            }

            const total = (basePrice * quantity).toFixed(2);
            singlePriceElement.innerText = "Total ‚Çπ" + total;
        }

        qtyInput.addEventListener("input", updatePrice);
    });



</script>

{# add to cart #}

<script>
document.addEventListener("DOMContentLoaded", function () {

    const qtyInput = document.getElementById("qtyInput");
    const addToCartBtn = document.getElementById("add_cart");
    const productSize = document.getElementById("product_size");
    const stitchedBox = document.getElementById("stitched_option");

    // üö® If elements not present, stop
    if (!qtyInput || !addToCartBtn) return;

    const minQty = parseInt(qtyInput.min || 1);
    const maxQty = parseInt(qtyInput.max || 0);

    // ‚ùå HARD STOP IF STOCK IS 0
    if (maxQty <= 0) {
        addToCartBtn.disabled = true;
        addToCartBtn.innerText = "Out of Stock";
        return;
    }

    addToCartBtn.addEventListener("click", function (e) {
        e.preventDefault();

        const quantity = parseInt(qtyInput.value);

        // Size validation
        if (productSize && (!productSize.value || productSize.value === "Select Size")) {
            alert("Please select a size");
            return;
        }

        // Quantity validation
        if (isNaN(quantity)) {
            alert("Please enter a valid quantity");
            return;
        }

        if (quantity < minQty) {
            alert(`Minimum quantity is ${minQty}`);
            return;
        }

        if (quantity > maxQty) {
            alert(`Only ${maxQty} items left in stock`);
            return;
        }

        // ‚úÖ AJAX ONLY AFTER ALL CHECKS
        let $btn = $(this);
        let originalText = $btn.html();

        $.ajax({
            type: "POST",
            url: "{% url 'add_cart' %}",
            data: {
                product_id: "{{ product.variant_id }}",
                qty: quantity,
                product_size: productSize ? productSize.value : null,
                product_color: "{{ product.color.name }}",
                is_stitched: stitchedBox ? (stitchedBox.checked ? 1 : 0) : 0,
                csrfmiddlewaretoken: "{{ csrf_token }}",
                action: "post"
            },
            success: function () {
                $("#cart_notice").text("Added to cart!").fadeIn().delay(1000).fadeOut();
                $btn.html("‚úîÔ∏è Added!");
                setTimeout(() => $btn.html(originalText), 1500);
            },
            error: function () {
                alert("Something went wrong. Try again.");
            }
        });
    });
});
</script>


<script>
console.log("SCRIPT LOADED");
$("#add_cart").on("click", () => console.log("BUTTON CLICKED"));
</script>


</body>

</html>